<!DOCTYPE html>
<html lang="{{ site.lang | default: 'en-US' }}">
{% include head.html %}
<body class="site-wrapper">
  <a class="btn btn--primary skip-link" href="#content">Skip to content</a>
  <div class="container container--wide">
      {% include header.html %} 

      {% if page.layout == "home" %}

  <!-- =================================== -->
  <!--      LAYOUT FOR HOMEPAGE ONLY       -->
  <!-- =================================== -->
  <main id="content">
    {{ content }}
  </main>
  
{% else %}

  <!-- =================================== -->
  <!-- LAYOUT FOR ALL OTHER PAGES (with Sidebar) -->
  <!-- =================================== -->
  <div class="l-main container">
    {% include sidebar.html %}
    <div class="l-main__body">
      <main id="content">
        {{ content }}
      </main>
    </div>
  </div>

{% endif %}


  </div>


  <!--
  This is the complete and corrected code for your search modal.
  Save this as `_includes/search-modal.html`
-->

<!-- =================================== -->
<!--         SEARCH MODAL HTML           -->
<!-- =================================== -->
<div class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="search-modal-title">
    <form id="search-form" role="search" onsubmit="event.preventDefault();">
        <h2 id="search-modal-title" class="sr-only">Site Search</h2>
        <div class="form-group-with-button">
            <input class="form-control" type="text" placeholder="Search posts, guides, stories..." id="search-input" autocomplete="off">
            <button type="submit" id="search-submit-button" class="btn btn--primary">
                Search
            </button>
        </div>
    </form>
    <div id="search-results-container" class="search-results-container">
        <!-- JavaScript will populate this area -->
    </div>
  </div>
</div>


<!-- =================================== -->
<!--          SEARCH MODAL CSS           -->
<!-- =================================== -->
<style>
    .modal-backdrop {
        position: fixed;
        inset: 0;
        background-color: rgba(10, 22, 41, 0.5);
        backdrop-filter: blur(4px);
        z-index: 100;
        display: none;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
        padding-top: 15vh;
        padding-inline: 1rem;
        text-align: center;
        overflow-y: auto; /* Allow scrolling if modal is too tall */
    }

    .modal-backdrop--open {
        display: block;
        opacity: 1;
    }

    .modal {
        display: inline-block;
        text-align: left;
        position: relative;
        width: 100%;
        max-width: 650px;
        background-color: var(--spruce-base-color-background);
        border-radius: var(--spruce-border-radius-lg, 0.925rem);
        box-shadow: var(--spruce-box-shadow, 0 0.75rem 1.25rem hsla(0, 0%, 0%, 0.1));
        padding: clamp(1rem, 5vw, 1.5rem);
        margin-bottom: 5vh;
    }

    .form-group-with-button {
        display: flex;
        gap: 0.5rem;
    }
    .form-group-with-button .form-control {
        flex-grow: 1;
    }
    
    .search-results-container {
        margin-top: 1.5rem;
        max-height: 60vh;
        overflow-y: auto;
    }

    .search-result-item {
        display: block;
        padding: 0.75rem 1rem;
        border-radius: var(--spruce-border-radius, 0.425rem);
        text-decoration: none;
        color: var(--spruce-base-color-text);
        border: 1px solid transparent;
        transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
    }

    .search-result-item:hover, .search-result-item:focus {
        background-color: var(--spruce-base-color-code-background);
        border-color: var(--spruce-base-color-border);
        outline: none;
    }

    .search-result-item__title {
        font-weight: 600;
        color: var(--spruce-base-color-heading);
    }

    .search-result-item__excerpt {
        font-size: var(--spruce-font-size-sm, 0.875rem);
        margin-top: 0.25rem;
        color: var(--spruce-base-color-text);
        line-height: 1.5;
    }

    .search-result-item mark {
        background-color: var(--spruce-base-color-mark-background);
        color: var(--spruce-base-color-mark-foreground);
        padding: 0;
        border-radius: 2px;
    }

    .search-results__message {
        text-align: center;
        padding: 2.5rem 1rem;
        color: var(--spruce-base-color-text);
        opacity: 0.8;
    }
</style>

<!-- =================================== -->
<!--         SEARCH MODAL JAVASCRIPT     -->
<!-- =================================== -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- UI Element References ---
        const openSearchButton = document.querySelector('.open-search');
        const modalBackdrop = document.querySelector('.modal-backdrop');
        const searchInput = document.getElementById('search-input');
        const searchForm = document.getElementById('search-form');
        const resultsContainer = document.getElementById('search-results-container');
        
        if (!openSearchButton || !modalBackdrop || !searchInput || !resultsContainer) {
            console.error("Search UI components are missing. Search will be disabled.");
            if(openSearchButton) openSearchButton.style.display = 'none';
            return;
        }

        // --- State & Config ---
        const siteBaseUrl = '{{ site.baseurl | default: "" }}';
        const searchDataUrl = '{{ "/assets/search.json" | relative_url }}';
        let searchData = [];
        let isModalOpen = false;
        let searchDebounceTimer;

        // --- Modal Management ---
        function openModal() {
            if (isModalOpen) return;
            modalBackdrop.classList.add('modal-backdrop--open'); 
            document.body.style.overflow = 'hidden';
            searchInput.focus();
            isModalOpen = true;
        }

        function closeModal() {
            if (!isModalOpen) return;
            modalBackdrop.classList.remove('modal-backdrop--open');
            document.body.style.overflow = '';
            isModalOpen = false;
        }

        // --- Search & Rendering Logic ---
        function findResults(termToMatch, dataToSearch) {
            if (!termToMatch) return [];
            const terms = termToMatch.toLowerCase().split(' ').filter(term => term.length > 1);
            if (terms.length === 0) return [];
            return dataToSearch.map(item => {
                let score = 0;
                const itemTitle = (item.title || '').toLowerCase();
                const itemContent = (item.content || '').toLowerCase();
                const itemDesc = (item.description || '').toLowerCase();
                const itemTags = Array.isArray(item.tags) ? item.tags.join(' ').toLowerCase() : '';
                const itemCategory = (item.category || '').toLowerCase();
                terms.forEach(term => {
                    if (itemTitle.includes(term)) score += 12;
                    if (itemDesc.includes(term)) score += 4;
                    if (itemTags.includes(term)) score += 6;
                    if (itemCategory.includes(term)) score += 8;
                    if (itemContent.includes(term)) score += 1;
                });
                return { ...item, score };
            }).filter(item => item.score > 0).sort((a, b) => b.score - a.score);
        }
        
        function highlightText(text, terms) {
            if (!text || !terms || terms.length === 0) return text;
            let sanitizedText = text.replace(/</g, "<").replace(/>/g, ">");
            terms.forEach(term => {
                const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                sanitizedText = sanitizedText.replace(regex, '<mark>$1</mark>');
            });
            return sanitizedText;
        }
        
        function displayResults(results, query) {
            const safeQuery = query.replace(/</g, "<").replace(/>/g, ">");
            if (!query) {
                resultsContainer.innerHTML = '<div class="search-results__message">Start typing to search the site.</div>';
                return;
            }
            if (results.length === 0) {
                resultsContainer.innerHTML = `<div class="search-results__message">No results found for "<strong>${safeQuery}</strong>".</div>`;
                return;
            }
            const terms = query.toLowerCase().split(' ').filter(term => term.length > 1);
            resultsContainer.innerHTML = results.slice(0, 7).map(item => {
                const url = (item.url && item.url.startsWith('/')) ? siteBaseUrl + item.url : (item.url || '#');
                const title = item.title || 'Untitled';
                const excerpt = (item.description || item.content || '').substring(0, 120) + '...';
                return `<a href="${url}" class="search-result-item">
                            <div class="search-result-item__title">${highlightText(title, terms)}</div>
                            <div class="search-result-item__excerpt">${highlightText(excerpt, terms)}</div>
                        </a>`;
            }).join('');
        }

        // --- Event Handling & Initialization ---
        function handleSearch() {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                const query = searchInput.value.trim();
                const results = findResults(query, searchData);
                displayResults(results, query);
            }, 250);
        }

        function setupEventListeners() {
            openSearchButton.addEventListener('click', (e) => { e.preventDefault(); openModal(); });
            document.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && (e.key === 'k' || e.key === 'K')) { e.preventDefault(); openModal(); } });
            modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && isModalOpen) closeModal(); });
            searchInput.addEventListener('input', handleSearch);
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const firstResultLink = resultsContainer.querySelector('.search-result-item');
                if(firstResultLink) {
                    window.location.href = firstResultLink.href;
                }
            });
        }

        function init() {
            resultsContainer.innerHTML = '<div class="search-results__message">Start typing to search the site.</div>';
            fetch(searchDataUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (!Array.isArray(data)) throw new Error("Search data is not a valid array.");
                    searchData = data;
                    setupEventListeners();
                    console.log("Custom search initialized successfully.");
                })
                .catch(error => {
                    console.error("Could not initialize custom search:", error);
                    resultsContainer.innerHTML = `<div class="search-results__message" style="color: var(--spruce-alert-color-danger);">Error: Could not load search data.</div>`;
                    if(openSearchButton) openSearchButton.style.display = 'none';
                });
        }

        init();
    });
</script>

  

  <!-- Scripts -->
  <script src="{{ '/_pagefind/pagefind-ui.js' | relative_url }}" onload="new PagefindUI({ element: '#search', showImages: false });"></script>
  <script src="{{ '/assets/js/theme-change-assets.js' | relative_url }}" defer="defer"></script>
  <script src="{{ '/assets/js/navigation.js' | relative_url }}" defer="defer"></script>
  <script src="{{ '/assets/js/theme-switcher.js' | relative_url }}" defer="defer"></script>
  <script src="{{ '/assets/js/modal.js' | relative_url }}" defer="defer"></script>
  <script src="{{ '/assets/js/accordion-card.js' | relative_url }}" defer="defer"></script>
</body>
</html>
