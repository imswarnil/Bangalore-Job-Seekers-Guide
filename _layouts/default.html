<!DOCTYPE html>
<html lang="{{ site.lang | default: 'en-US' }}">
{% include head.html %}
<body class="site-wrapper">
  <a class="btn btn--primary skip-link" href="#content">Skip to content</a>
  <div class="container container--wide">
      {% include header.html %} 

      {% if page.layout == "home" %}

  <!-- =================================== -->
  <!--      LAYOUT FOR HOMEPAGE ONLY       -->
  <!-- =================================== -->
  <main id="content">
    {{ content }}
  </main>
  
{% else %}

  <!-- =================================== -->
  <!-- LAYOUT FOR ALL OTHER PAGES (with Sidebar) -->
  <!-- =================================== -->
  <div class="l-main container">
    {% include sidebar.html %}
    <div class="l-main__body">
      <main id="content">
        {{ content }}
      </main>
    </div>
  </div>

{% endif %}


  </div>


  <!--
  ======================================================================
  COMPLETE SEARCH MODAL SOLUTION
  Place this entire block at the bottom of your `_layouts/default.html` file.
  ======================================================================
-->

<!-- 1. The Modal HTML Structure -->
<div id="search-modal-backdrop" class="modal-backdrop">
  <div id="search-modal-content" class="modal-content-wrapper" role="dialog" aria-modal="true" aria-labelledby="search-modal-title">
    <!-- The Search UI Component will be loaded here by JavaScript -->
    <div class="spinner-container">
        <div class="spinner"></div>
        <p>Loading Search...</p>
    </div>
  </div>
</div>

<!-- 2. The CSS Styles for the Modal and Search UI -->
<style>
    /* Correct Modal CSS */
    .modal-backdrop {
        position: fixed;
        inset: 0;
        background-color: rgba(10, 22, 41, 0.7);
        backdrop-filter: blur(5px);
        z-index: 1000;
        display: none; /* Hidden by default */
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
        padding: 5vh 1rem;
        overflow-y: auto;
    }
    .modal-backdrop--open {
        display: block;
        opacity: 1;
    }
    .modal-content-wrapper {
        background-color: var(--spruce-base-color-background);
        border-radius: var(--spruce-border-radius-lg, 0.925rem);
        max-width: 800px;
        margin: 0 auto;
        padding: clamp(1.5rem, 5vw, 3rem);
        text-align: left; /* Reset alignment for content */
    }
    
    /* Search Component CSS */
    .search-form-wrapper {
        margin-bottom: 2rem;
    }
    .search-results-wrapper {
        margin-top: 2rem;
    }
    .search-results-header {
        display: flex; justify-content: space-between; align-items: baseline;
        border-bottom: 1px solid var(--spruce-base-color-border);
        padding-bottom: 1rem; margin-bottom: 2.5rem;
    }
    .search-results-count {
        color: var(--spruce-base-color-text);
        font-size: var(--spruce-font-size-sm);
    }
    .search-results-grid {
        display: grid; gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
    .result-card { background-color: var(--spruce-card-color-background); border: 1px solid var(--spruce-base-color-border); border-radius: var(--spruce-border-radius); display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    .result-card:hover { transform: translateY(-5px); box-shadow: var(--spruce-box-shadow); }
    .result-card__image figure { margin: 0; background-color: var(--spruce-base-color-code-background); height: 180px; display: flex; align-items: center; justify-content: center; }
    .result-card__image img { display: block; width: 100%; height: 100%; object-fit: cover; }
    .result-card__content { padding: 1.5rem; flex-grow: 1; display: flex; flex-direction: column; }
    .result-card__title { font-family: var(--spruce-font-family-heading); font-weight: var(--spruce-font-weight-heading); font-size: 1.125rem; color: var(--spruce-base-color-heading); margin-bottom: 0.5rem; line-height: 1.3; }
    .result-card__title a { text-decoration: none; color: inherit; }
    .result-card__link-overlay { position: absolute; inset: 0; z-index: 1; }
    .result-card__category { font-size: var(--spruce-font-size-sm); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; color: var(--spruce-base-color-primary); margin-bottom: 0.75rem; }
    .result-card__excerpt { font-size: 0.95rem; color: var(--spruce-base-color-text); line-height: 1.6; }
    .result-card__tags { margin-top: auto; padding-top: 1rem; }
    .result-card__tags .tag { display: inline-block; font-size: var(--spruce-font-size-sm); background-color: var(--spruce-base-color-code-background); color: var(--spruce-base-color-code-foreground); padding: 0.25em 0.75em; border-radius: 9999px; margin-right: 0.5rem; margin-bottom: 0.5rem; }
    .no-results-message { text-align: center; background-color: var(--spruce-footer-color-background); border: 1px dashed var(--spruce-base-color-border); border-radius: var(--spruce-border-radius); padding: 3rem; }
    .no-results-message .icon-placeholder { color: var(--spruce-form-color-border); margin-bottom: 1rem; }
    .no-results-message h3, .no-results-message p { color: var(--spruce-base-color-text); }
    .spinner-container { text-align: center; padding: 4rem 2rem; color: var(--spruce-base-color-text); }
    .spinner { border: 4px solid var(--spruce-base-color-border); border-top: 4px solid var(--spruce-base-color-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<!-- 3. The JavaScript to Control Everything -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- UI & State ---
    const openSearchButton = document.querySelector('.open-search');
    const modalBackdrop = document.getElementById('search-modal-backdrop');
    const modalContent = document.getElementById('search-modal-content');
    let isModalOpen = false;
    let isSearchInitialized = false;

    // --- Modal Management ---
    function openModal() {
        if (isModalOpen) return;
        modalBackdrop.classList.add('modal-backdrop--open');
        document.body.style.overflow = 'hidden';
        isModalOpen = true;

        if (!isSearchInitialized) {
            loadAndInitSearch();
        } else {
             // If already initialized, just focus the input
             const searchInput = document.getElementById('search-input');
             if (searchInput) {
                searchInput.focus();
             }
        }
    }

    function closeModal() {
        if (!isModalOpen) return;
        modalBackdrop.classList.remove('modal-backdrop--open');
        document.body.style.overflow = '';
        isModalOpen = false;
    }

    // --- The Main Logic: Load UI then run the Search Script ---
    function loadAndInitSearch() {
        const searchUIHtml = `
            <div class="search-form-wrapper">
                <form id="search-form" onsubmit="event.preventDefault();" role="search">
                    <div class="form-group--stacked">
                        <input class="form-control form-control--lg" type="text" placeholder="Search posts, guides, stories..." name="q" id="search-input" autocomplete="off">
                        <button type="submit" id="search-submit-button" class="btn btn--primary btn--lg">Search</button>
                    </div>
                </form>
            </div>
            <div id="search-results" class="search-results-wrapper">
                <div id="results-container" class="search-results-grid"></div>
                <div id="no-results" class="no-results-message" style="display: none;">
                    <h3 class="h4">No results found</h3>
                    <p>Try different keywords or check your spelling.</p>
                </div>
            </div>`;
        
        modalContent.innerHTML = searchUIHtml;
        runSearchLogic(); // Now that HTML exists, initialize the script
        isSearchInitialized = true;
        document.getElementById('search-input').focus();
    }
    
    function runSearchLogic() {
        // --- This is your powerful search script, now targeted at the loaded HTML ---
        const siteBaseUrl = '{{ site.baseurl | default: "" }}';
        const endpoint = '{{ "/assets/search.json" | relative_url }}';
        let searchData = [];

        const searchInput = document.getElementById('search-input');
        const searchForm = document.getElementById('search-form');
        const resultsContainer = document.getElementById('results-container');
        const noResultsDiv = document.getElementById('no-results');
        
        // --- Helper functions ---
        function highlightText(text, terms) {
            if (!text || !terms || terms.length === 0) return text;
            let sanitizedText = text.replace(/</g, "<").replace(/>/g, ">");
            terms.forEach(term => {
                const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                sanitizedText = sanitizedText.replace(regex, '<mark>$1</mark>');
            });
            return sanitizedText;
        }

        // --- Core search logic ---
        function findResults(termToMatch) {
            if (!termToMatch) return [];
            const terms = termToMatch.toLowerCase().split(' ').filter(term => term.length > 1);
            if (terms.length === 0) return [];

            return searchData.map(item => {
                let score = 0;
                const itemTitle = (item.title || '').toLowerCase();
                const itemContent = (item.content || '').toLowerCase();
                const itemDesc = (item.description || '').toLowerCase();
                const itemTags = Array.isArray(item.tags) ? item.tags.join(' ').toLowerCase() : '';
                const itemCategory = (item.category || '').toLowerCase();
                
                terms.forEach(term => {
                    if (itemTitle.includes(term)) score += 12;
                    if (itemDesc.includes(term)) score += 4;
                    if (itemTags.includes(term)) score += 6;
                    if (itemCategory.includes(term)) score += 8;
                    if (itemContent.includes(term)) score += 1;
                });
                return { ...item, score };
            }).filter(item => item.score > 0).sort((a, b) => b.score - a.score);
        }
        
        function displayResults(results, query) {
            if (!query) {
                resultsContainer.innerHTML = '';
                noResultsDiv.style.display = 'none';
                return;
            }

            if (results.length > 0) {
                noResultsDiv.style.display = 'none';
                resultsContainer.innerHTML = results.map(item => {
                    const itemUrl = (item.url && item.url.startsWith('/')) ? siteBaseUrl + item.url : (item.url || '#');
                    const displayTitle = item.title || 'Untitled';
                    const categoryName = item.category || 'Page';
                    const descMaxLength = 100;
                    const descriptionSnippet = item.description ?
                        highlightText(String(item.description).substring(0, descMaxLength) + '...', terms) :
                        (item.content ? highlightText(String(item.content).substring(0, descMaxLength) + '...', terms) : '');

                    return `
                        <article class="result-card">
                            <a href="${itemUrl}" class="result-card__link-overlay" aria-label="${displayTitle}"></a>
                            <div class="result-card__content">
                                <p class="result-card__category">${categoryName}</p>
                                <h3 class="result-card__title"><a href="${itemUrl}">${highlightText(displayTitle, terms)}</a></h3>
                                <p class="result-card__excerpt">${descriptionSnippet}</p>
                            </div>
                        </article>`;
                }).join('');
            } else {
                resultsContainer.innerHTML = '';
                noResultsDiv.style.display = 'block';
                const safeSearchTerm = query.replace(/</g, "<").replace(/>/g, ">");
                noResultsDiv.querySelector('h3').innerHTML = `No results for "${safeSearchTerm}"`;
            }
        }

        let debounceTimer;
        function handleSearchInput() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const term = searchInput.value.trim();
                const results = findResults(term);
                displayResults(results, term);
            }, 300);
        }

        fetch(endpoint)
            .then(res => res.json())
            .then(data => {
                searchData = data;
                searchInput.addEventListener('input', handleSearchInput);
                searchForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const firstResultLink = resultsContainer.querySelector('.result-card__link-overlay');
                    if (firstResultLink) {
                        window.location.href = firstResultLink.href;
                    }
                });
                console.log("Custom Search logic has been initialized inside the modal.");
            })
            .catch(err => {
                console.error("Failed to load search data for modal:", err);
                resultsContainer.innerHTML = `<p style="color:var(--spruce-alert-color-danger)">Could not load search data.</p>`;
            });
    }

    // --- Setup Global Event Listeners ---
    openSearchButton.addEventListener('click', (e) => { e.preventDefault(); openModal(); });
    document.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && (e.key === 'k' || e.key === 'K')) { e.preventDefault(); openModal(); } });
    modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && isModalOpen) closeModal(); });
});
</script>

  

  <!-- Scripts -->
  <script src="{{ '/_pagefind/pagefind-ui.js' | relative_url }}" onload="new PagefindUI({ element: '#search', showImages: false });"></script>
  <script src="{{ '/assets/js/theme-change-assets.js' | relative_url }}" defer="defer"></script>
  <script src="{{ '/assets/js/navigation.js' | relative_url }}" defer="defer"></script>
  <script src="{{ '/assets/js/theme-switcher.js' | relative_url }}" defer="defer"></script>
  <script src="{{ '/assets/js/modal.js' | relative_url }}" defer="defer"></script>
  <script src="{{ '/assets/js/accordion-card.js' | relative_url }}" defer="defer"></script>
</body>
</html>
