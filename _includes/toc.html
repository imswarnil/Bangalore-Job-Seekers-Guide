{%- comment -%}
============================================================
PART 1: TOC GENERATION LOGIC
This part scans the post's HTML content and prepares a list
of `<li>` elements in a variable called `my_toc`.
This logic is preserved from your original code.
============================================================
{%- endcomment -%}
{%- capture toc_logic -%}
  {%- capture my_toc -%}{%- endcapture -%}
  {%- assign minHeader = include.h_min | default: 2 -%}
  {%- assign maxHeader = include.h_max | default: 3 -%}
  {%- assign nodes = include.html | split: '<h' -%}
  {%- assign firstHeader = true -%}

  {%- for node in nodes -%}
    {%- if node == "" -%}{%- continue -%}{%- endif -%}
    {%- assign headerLevel = node | slice: 0, 1 | times: 1 -%}
    {%- if headerLevel < minHeader or headerLevel > maxHeader -%}{%- continue -%}{%- endif -%}
    {%- if firstHeader -%}
      {%- assign firstHeader = false -%}
      {%- assign minHeader = headerLevel -%}
    {%- endif -%}

    {%- assign _workspace = node | split: '</h' -%}
    {%- assign _idWorkspace = _workspace[0] | split: 'id="' -%}
    {%- if _idWorkspace.size <= 1 -%}{%- continue -%}{%- endif -%}
    {%- assign _idWorkspace = _idWorkspace[1] | split: '"' -%}
    {%- assign html_id = _idWorkspace[0] -%}

    {%- if html_id == blank -%}{%- continue -%}{%- endif -%}

    {%- capture _hAttrToStrip -%}{{ _workspace[0] | split: '>' | first }}>{%- endcapture -%}
    {%- assign header = _workspace[0] | replace: _hAttrToStrip, '' -%}
    {%- capture heading_body -%}{{ header | strip_html }}{%- endcapture -%}

    {%- capture my_toc -%}{{ my_toc }}<li><a href="#{{ html_id }}">{{ heading_body | replace: "|", "\|" }}</a></li>{%- endcapture -%}
  {%- endfor -%}
{%- endcapture -%}

{%- comment -%}
============================================================
PART 2: HTML OUTPUT
This renders the final HTML, placing the generated `my_toc`
list into the correct structure you specified.
============================================================
{%- endcomment -%}
<section class="toc" aria-labelledby="toc-title">
  <h3 class="toc__title" id="toc-title">On this page</h3>
  <nav class="toc__navigation">
    <ol>
      {{- my_toc -}}
    </ol>
  </nav>
</section>

{%- comment -%}
============================================================
PART 3: SCROLL-SPY JAVASCRIPT
This is the corrected and robust JavaScript for highlighting
the active section as the user scrolls.
============================================================
{%- endcomment -%}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Select all the heading elements within your main post content.
    const sections = document.querySelectorAll('.post-content h2[id], .post-content h3[id]');
    
    // **CORRECTED SELECTOR**: Select all links within the TOC's navigation area.
    const tocLinks = document.querySelectorAll('.toc__navigation a');

    // If there are no headings or TOC links, do nothing. This prevents errors.
    if (sections.length === 0 || tocLinks.length === 0) {
      return;
    }

    const spyScroll = () => {
      let currentSectionId = "";

      // Loop through all sections to find which one is currently in view.
      sections.forEach(section => {
        const sectionTop = section.offsetTop;
        // An offset of 150px makes the link active slightly before the heading reaches the very top of the screen.
        if (window.scrollY >= sectionTop - 150) {
          currentSectionId = section.getAttribute('id');
        }
      });

      // Now, loop through all the TOC links and update their 'active' state.
      tocLinks.forEach(link => {
        // Remove the active class from all links first.
        link.classList.remove('is-active');
        
        // If a link's href matches the current section ID, add the active class.
        // e.g., href="#css-customization" matches id="css-customization"
        if (link.getAttribute('href') === '#' + currentSectionId) {
          link.classList.add('is-active');
        }
      });
    };

    // Run the function once on page load and on every scroll event.
    spyScroll();
    window.addEventListener('scroll', spyScroll, { passive: true }); // passive:true for better performance
  });
</script>