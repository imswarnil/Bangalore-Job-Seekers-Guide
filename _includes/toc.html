{%- comment -%}
============================================================
PART 1: TOC & JSON-LD DATA PREPARATION
This section generates two things at once:
1. An HTML list of links for the visible TOC (`my_toc`).
2. A JSON array of the same links for the JSON-LD schema (`json_ld_items`).
This is highly efficient as we only loop through the content once.
============================================================
{%- endcomment -%}
{%- capture toc_logic -%}
  {%- assign page_url = page.url | absolute_url -%}
  {%- capture my_toc -%}{%- endcapture -%}
  {%- capture json_ld_items -%}{%- endcapture -%}
  {%- assign minHeader = include.h_min | default: 2 -%}
  {%- assign maxHeader = include.h_max | default: 3 -%}
  {%- assign nodes = include.html | split: '<h' -%}

  {%- for node in nodes -%}
    {%- if node == "" -%}{%- continue -%}{%- endif -%}
    {%- assign headerLevel = node | slice: 0, 1 | times: 1 -%}
    {%- if headerLevel < minHeader or headerLevel > maxHeader -%}{%- continue -%}{%- endif -%}

    {%- assign _workspace = node | split: '</h' -%}
    {%- assign _idWorkspace = _workspace[0] | split: 'id="' -%}
    {%- if _idWorkspace.size <= 1 -%}{%- continue -%}{%- endif -%}
    {%- assign _idWorkspace = _idWorkspace[1] | split: '"' -%}
    {%- assign html_id = _idWorkspace[0] -%}

    {%- if html_id == blank -%}{%- continue -%}{%- endif -%}

    {%- capture _hAttrToStrip -%}{{ _workspace[0] | split: '>' | first }}>{%- endcapture -%}
    {%- assign header = _workspace[0] | replace: _hAttrToStrip, '' -%}
    {%- assign heading_body = header | strip_html | strip -%}
    {%- assign heading_body_json = heading_body | json | remove_first: '"' | remove_last: '"' -%}
    
    {%- comment -%} Build the visible HTML list item {%- endcomment -%}
    {%- capture my_toc -%}
      {{ my_toc }}<li><a href="#{{ html_id }}">{{ heading_body }}</a></li>
    {%- endcapture -%}

    {%- comment -%} Build the JSON-LD list item {%- endcomment -%}
    {%- capture json_ld_items -%}
      {{ json_ld_items }}{
        "@type": "ListItem",
        "position": forloop.index,
        "name": "{{ heading_body_json }}",
        "url": "{{ page_url }}#{{ html_id }}"
      },
    {%- endcapture -%}
  {%- endfor -%}
  {%- assign json_ld_items = json_ld_items | strip | remove_last: "," -%}
{%- endcapture -%}

{%- comment -%}
============================================================
PART 2: HTML OUTPUT
This renders the final visible component, including the TOC
and an AdSense slot.
============================================================
{%- endcomment -%}
<section class="toc" aria-labelledby="toc-title">
  <h3 class="toc__title" id="toc-title">On this page</h3>
  <nav class="toc__navigation">
    <ol>
      {{- my_toc -}}
    </ol>
  </nav>
</section>

{%- comment -%}
============================================================
PART 3: JSON-LD STRUCTURED DATA
This script tag is invisible to the user but highly valuable
for search engines like Google. It tells them about the
navigational structure of your page.
============================================================
{%- endcomment -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "Article Sections",
  "itemListElement": [
    {{ json_ld_items }}
  ]
}
</script>

{%- comment -%}
============================================================
PART 4: SCROLL-SPY JAVASCRIPT
This provides the interactive highlighting for the user.
============================================================
{%- endcomment -%}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const sections = document.querySelectorAll('.post-content h2[id], .post-content h3[id]');
    const tocLinks = document.querySelectorAll('.toc__navigation a');

    if (sections.length === 0 || tocLinks.length === 0) return;

    const spyScroll = () => {
      let currentSectionId = "";
      const scrollY = window.scrollY;

      sections.forEach(section => {
        const sectionTop = section.offsetTop;
        if (scrollY >= sectionTop - 150) {
          currentSectionId = section.getAttribute('id');
        }
      });

      tocLinks.forEach(link => {
        const linkHref = link.getAttribute('href');
        if (linkHref === '#' + currentSectionId) {
          link.classList.add('is-active');
        } else {
          link.classList.remove('is-active');
        }
      });
    };

    window.addEventListener('scroll', spyScroll, { passive: true });
    spyScroll(); // Initial call to set the state on page load
  });
</script>