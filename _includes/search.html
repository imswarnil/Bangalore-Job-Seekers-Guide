<!--
============================================================
PART 1: THE STYLES (SCSS)
This block contains all the necessary styling, written to
perfectly match your Spruce CSS theme variables and provide
a superior responsive experience.
============================================================
-->
<style>
  .search-page-layout {
    padding-block: clamp(2rem, 5vw, 4rem);
  }

  .search-form-wrapper {
    max-width: 48rem; // A comfortable width for a primary search bar
    margin: 0 auto 4rem auto;
    text-align: center;
  }

  .search-page-title {
    color: var(--spruce-base-color-heading);
    margin-bottom: 0.5rem;
  }

  .search-page-subtitle {
    color: var(--spruce-base-color-text);
    margin-bottom: 2rem;
    font-size: var(--spruce-font-size-lead);
  }

  // A fully responsive, modern search form group
  .search-form-group {
    display: flex;
    border: 1px solid var(--spruce-form-color-border);
    border-radius: var(--spruce-border-radius-lg); // A nice, modern rounded look
    background-color: var(--spruce-form-color-background);
    transition: box-shadow 0.2s ease;
    overflow: hidden;

    &:focus-within {
      border-color: var(--spruce-form-color-border-focus);
      box-shadow: 0 0 0 4px var(--spruce-form-color-ring-focus);
    }
  }
  
  .search-form-group .form-control {
    flex-grow: 1;
    border: none;
    background-color: transparent;
    padding: 0.9em 1.25em; // More comfortable padding
    font-size: var(--spruce-font-size-lg); // Larger font for better readability
    box-shadow: none !important; // Override default focus styles
    outline: none;
  }
  
  .search-form-group .btn {
    border: none;
    border-left: 1px solid var(--spruce-form-color-border);
    border-radius: 0; // The parent container handles the radius
    padding-inline: 1.5rem;
  }

  // Responsive adjustments for the search form on small screens
  @media (max-width: 600px) {
    .search-form-group {
      flex-direction: column;
      border: none;
      background-color: transparent;
      box-shadow: none !important;

      &:focus-within {
        box-shadow: none;
      }
      
      .form-control {
        border: 1px solid var(--spruce-form-color-border);
        border-radius: var(--spruce-border-radius);
        margin-bottom: 0.75rem;
        padding: 0.75em 1em;
        font-size: var(--spruce-font-size-base);

        &:focus {
          border-color: var(--spruce-form-color-border-focus);
          box-shadow: 0 0 0 4px var(--spruce-form-color-ring-focus);
        }
      }
      
      .btn {
        width: 100%;
        border: 1px solid var(--spruce-btn-color-primary-background);
        border-radius: var(--spruce-border-radius);
      }
    }
  }

  // Header for the search results section
  .search-results-header {
    display: flex;
    flex-wrap: wrap; // Allow wrapping on small screens
    justify-content: space-between;
    align-items: baseline;
    gap: 0.5rem 1rem;
    border-bottom: 1px solid var(--spruce-base-color-border);
    padding-bottom: 1rem;
    margin-bottom: 2.5rem;
  }

  .search-results-count {
    color: var(--spruce-base-color-text);
    font-size: var(--spruce-font-size-sm);
  }

  // The definitive responsive grid for result cards
  .search-results-grid {
    display: grid;
    gap: 1.75rem;
    grid-template-columns: repeat(auto-fill, minmax(min(100%, 320px), 1fr));
  }

  // A completely redesigned, more scannable result card
  .result-card {
    background-color: var(--spruce-card-color-background);
    border: 1px solid var(--spruce-base-color-border);
    border-radius: var(--spruce-border-radius-lg);
    display: flex;
    flex-direction: column;
    height: 100%;
    text-decoration: none;
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;

    &:hover {
      transform: translateY(-5px);
      border-color: var(--spruce-base-color-primary);
      box-shadow: var(--spruce-box-shadow, 0 10px 25px hsla(0, 0%, 0%, 0.08));
    }
  }
  
  .result-card__image {
    figure { margin: 0; }
    img {
      display: block;
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-top-left-radius: var(--spruce-border-radius-lg);
      border-top-right-radius: var(--spruce-border-radius-lg);
    }
  }

  .result-card__content {
    padding: 1.5rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  .result-card__category {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 700;
    color: var(--spruce-base-color-primary);
    margin: 0;
  }

  .result-card__title {
    font-family: var(--spruce-font-family-heading);
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--spruce-base-color-heading);
    margin: 0.5rem 0 0.75rem 0;
    line-height: 1.3;
  }

  .result-card__excerpt {
    font-size: 0.95rem;
    color: var(--spruce-base-color-text);
    line-height: 1.6;
    margin: 0;
  }
  
  .result-card__excerpt mark {
    background-color: hsla(50, 100%, 80%, 0.7);
    color: inherit;
  }

  // State messages (Loading, No Results, Error)
  .search-state-message {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--spruce-base-color-text);
  }
  .spinner {
    border: 4px solid var(--spruce-base-color-border);
    border-top: 4px solid var(--spruce-base-color-primary);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem auto;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>


<!--
============================================================
PART 2: THE HTML STRUCTURE
Refined for clarity, accessibility, and better UX.
============================================================
-->
<section class="section search-page-layout">
  <div class="container container--wide">

    <!-- Search Form Wrapper -->
    <div class="search-form-wrapper">
      <h1 class="h2 search-page-title">Search Site Content</h1>
      <p class="search-page-subtitle">Find articles, guides, and answers across the entire site.</p>
      <form id="search-form" onsubmit="event.preventDefault();" role="search">
        <div class="search-form-group">
          <input class="form-control" type="search" placeholder="e.g., 'resume tips' or 'interview'" name="q" id="search-input" autocomplete="off" aria-label="Search Query">
          <button type="submit" id="search-submit-button" class="btn btn--primary btn--lg">Search</button>
        </div>
      </form>
    </div>

    <!-- Search Results Wrapper -->
    <div id="search-results-wrapper">
      <header class="search-results-header" style="display: none;">
        <h2 class="h3" id="results-heading"></h2>
        <p id="results-count" class="search-results-count"></p>
      </header>
      
      <!-- Container for dynamic content (spinner, results, messages) -->
      <div id="search-dynamic-container">
        <!-- Initial state is empty. JS will inject content here. -->
      </div>
    </div>

  </div>
</section>

<!--
============================================================
PART 3: THE JAVASCRIPT LOGIC
Refined for better scoring, performance, and UX.
============================================================
-->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const siteBaseUrl = '{{ site.baseurl | default: "" }}';
  const endpoint = '{{ "/assets/search.json" | relative_url }}';
  
  let searchData = [];
  let isSearchLoading = false;

  // --- DOM Element References ---
  const searchInput = document.getElementById('search-input');
  const searchForm = document.getElementById('search-form');
  const dynamicContainer = document.getElementById('search-dynamic-container');
  const resultsHeader = document.querySelector('.search-results-header');
  const resultsHeading = document.getElementById('results-heading');
  const resultsCountP = document.getElementById('results-count');

  // --- UI State Functions ---
  const showLoading = () => {
    isSearchLoading = true;
    resultsHeader.style.display = 'none';
    dynamicContainer.innerHTML = `
      <div class="search-state-message">
        <div class="spinner"></div>
        <p>Searching...</p>
      </div>`;
  };
  
  const showError = (message) => {
    isSearchLoading = false;
    resultsHeader.style.display = 'none';
    dynamicContainer.innerHTML = `
      <div class="search-state-message no-results-message">
        <h3 class="h4">Something went wrong</h3>
        <p>${message}</p>
      </div>`;
  };

  const showNoResults = (query) => {
    isSearchLoading = false;
    resultsHeader.style.display = 'flex';
    resultsHeading.innerHTML = `No results for "<em>${query.replace(/</g, "<")}</em>"`;
    resultsCountP.textContent = '';
    dynamicContainer.innerHTML = `
      <div class="search-state-message no-results-message">
        <h3 class="h4">Try adjusting your search</h3>
        <p>Try different keywords, check your spelling, or be less specific.</p>
      </div>`;
  };

  // --- Helper Functions ---
  const highlightText = (text, terms) => {
    if (!text || !terms || terms.length === 0) return text;
    const escapedText = String(text).replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">");
    return terms.reduce((acc, term) => {
        const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return acc.replace(regex, '<mark>$1</mark>');
    }, escapedText);
  };
  
  const findResults = (query, data) => {
    const terms = query.toLowerCase().split(' ').filter(term => term.length > 2);
    if (terms.length === 0) return [];

    return data.map(item => {
        let score = 0;
        const title = (item.title || '').toLowerCase();
        const content = (item.content || '').toLowerCase();
        const category = (item.category || '').toLowerCase();
        const tags = Array.isArray(item.tags) ? item.tags.join(' ').toLowerCase() : '';
        
        terms.forEach(term => {
            if (title.includes(term)) score += 12;
            if (category.includes(term)) score += 8;
            if (tags.includes(term)) score += 6;
            if (content.includes(term)) score += 1;
        });
        return { ...item, score };
    }).filter(item => item.score > 0).sort((a, b) => b.score - a.score);
  };

  const displayResults = (results, query) => {
    isSearchLoading = false;
    resultsHeader.style.display = 'flex';
    resultsHeading.innerHTML = `Search Results`;
    resultsCountP.textContent = `${results.length} ${results.length === 1 ? 'result' : 'results'} found`;

    const resultsGrid = document.createElement('div');
    resultsGrid.className = 'search-results-grid';

    resultsGrid.innerHTML = results.map(item => {
      const url = siteBaseUrl + item.url;
      const title = item.title || 'Untitled';
      const category = item.category || 'Page';
      const excerpt = item.content ? highlightText(String(item.content).substring(0, 120) + '...', query.split(' ')) : 'No description available.';
      
      // Fallback for image
      let imageHtml = `<div class="result-card__image"><figure style="height: 180px; display:flex; align-items:center; justify-content:center; background-color: var(--spruce-base-color-code-background);"><span style="font-size: 2rem; color: var(--spruce-base-color-border);">&_#128214;</span></figure></div>`;
      if (item.image) {
        imageHtml = `<div class="result-card__image"><img src="${siteBaseUrl}${item.image}" alt="" loading="lazy"></div>`;
      }

      return `
        <a href="${url}" class="result-card">
          ${imageHtml}
          <div class="result-card__content">
            <p class="result-card__category">${category}</p>
            <h3 class="result-card__title">${highlightText(title, query.split(' '))}</h3>
            <p class="result-card__excerpt">${excerpt}</p>
          </div>
        </a>`;
    }).join('');
    
    dynamicContainer.innerHTML = '';
    dynamicContainer.appendChild(resultsGrid);
  };

  // --- Event Handling & Initialization ---
  const performSearch = () => {
    if (isSearchLoading) return;
    const query = searchInput.value.trim();
    if (query.length < 2) {
      dynamicContainer.innerHTML = '';
      resultsHeader.style.display = 'none';
      return;
    }

    showLoading();
    setTimeout(() => {
        try {
            const results = findResults(query, searchData);
            if (results.length > 0) {
                displayResults(results, query);
            } else {
                showNoResults(query);
            }
        } catch (e) {
            console.error("Search error:", e);
            showError("An unexpected error occurred during the search.");
        }
    }, 100); // Simulate network delay for better UX
  };

  const initSearch = () => {
    fetch(endpoint)
      .then(response => {
        if (!response.ok) throw new Error(`Could not load search index: ${response.statusText}`);
        return response.json();
      })
      .then(data => {
        if (!Array.isArray(data)) throw new Error("Search index is not a valid JSON array.");
        searchData = data;
        
        searchForm.addEventListener('submit', performSearch);

        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q');
        if (query) {
          searchInput.value = decodeURIComponent(query.replace(/\+/g, ' '));
          performSearch();
        }
      })
      .catch(e => {
        console.error('Failed to initialize search:', e);
        showError(e.message);
      });
  };

  initSearch();
});
</script>

<noscript>
  <div class="container" style="padding-top: 2rem;">
    <p class="alert alert--warning">JavaScript is required for the search functionality.</p>
  </div>
</noscript>