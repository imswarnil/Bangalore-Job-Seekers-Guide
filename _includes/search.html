
<section class="section search-section-bulma"> {/* Scoped class for clarity, but no custom CSS for it */}
  <div class="container">
    <!-- Search Form -->
    <div class="columns is-centered">
      <div class="column is-half-desktop is-two-thirds-tablet">
        <form id="search-form" onsubmit="event.preventDefault(); performFullSearch(); return false;">
          <div class="field has-addons">
            <div class="control is-expanded has-icons-left">
              <input class="input is-medium is-rounded" type="text" placeholder="Search posts, videos, pages..." name="q" id="search-input" autocomplete="off">
              <span class="icon is-left is-medium"><i class="ph-bold ph-magnifying-glass"></i></span>
              <div class="dropdown" id="search-suggestions" style="position: absolute; width: 100%; z-index: 20;">
                <div class="dropdown-menu" id="dropdown-menu-suggestions" role="menu" style="width: 100%; display: none;">
                  <div class="dropdown-content" id="suggestions-content">
                  </div>
                </div>
              </div>
            </div>
            <div class="control">
              <button type="submit" id="search-submit-button" class="button is-primary is-medium is-rounded">
                <span class="icon search-button-icon"><i class="ph-bold ph-magnifying-glass"></i></span>
                <span class="search-button-text is-hidden-mobile">Search</span>
                <span class="search-button-loading" style="display: none;"><span class="icon"><i class="ph-bold ph-spinner fa-pulse"></i></span></span>
              </button>
            </div>
          </div>
        </form>
        <p class="help is-size-7 has-text-centered mt-2">Type for instant results or press Enter/click Search</p>
      </div>
    </div>

    <!-- Search Results Section -->
    <div id="search-results" class="mt-5" style="display: none;">
       <div class="level is-mobile mb-4">
         <div class="level-left"><h2 class="title is-4">Search Results</h2></div>
         <div class="level-right"><p class="has-text-grey is-size-7" id="results-count"></p></div>
       </div>
       <div>
           <div class="columns is-multiline" id="results-container">
           </div>
       </div>
       <div id="search-loading-spinner" class="has-text-centered mt-5 py-6" style="display: none;">
         <button class="button is-loading is-large is-primary is-outlined" disabled>Loading</button>
         <p class="has-text-grey mt-3">Searching...</p>
       </div>
       <div id="no-results" class="has-text-centered mt-5" style="display: none;">
          <div class="box content has-text-centered">
            <p><span class="icon is-large has-text-grey-light"><i class="ph-bold ph-binoculars is-size-1"></i></span></p>
            <h3 class="title is-5 mt-4">No results found</h3>
            <p class="subtitle is-6 has-text-grey">Try different keywords or check your spelling.</p>
          </div>
        </div>
       <div id="search-error" class="mt-5" style="display: none;">
       </div>
     </div>
  </div>
</section>

<!-- JavaScript (with modifications for Bulma-only styling) -->
<!-- Place this script at the bottom of your default.html layout, before the closing </body> tag -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- UI Element References ---
    const openSearchButton = document.querySelector('.open-search');
    const modalBackdrop = document.querySelector('.modal-backdrop');
    const searchInput = document.querySelector('.pagefind-ui__search-input');
    const searchResultsContainer = document.querySelector('.pagefind-ui__drawer');
    const searchClearButton = document.querySelector('.pagefind-ui__search-clear');
    
    // Check if all essential elements are present
    if (!openSearchButton || !modalBackdrop || !searchInput || !searchResultsContainer || !searchClearButton) {
        console.error("Search UI components are missing. Search will not function.");
        return;
    }

    // --- State & Config ---
    const siteBaseUrl = '{{ site.baseurl | default: "" }}';
    const searchDataUrl = '{{ "/assets/search.json" | relative_url }}';
    let searchData = [];
    let isModalOpen = false;
    let searchDebounceTimer;

    // --- Modal Management ---
    function openModal() {
        if (isModalOpen) return;
        modalBackdrop.classList.add('modal-backdrop--open');
        document.body.style.overflow = 'hidden'; // Prevent background scroll
        searchInput.focus();
        isModalOpen = true;
    }

    function closeModal() {
        if (!isModalOpen) return;
        modalBackdrop.classList.remove('modal-backdrop--open');
        document.body.style.overflow = '';
        isModalOpen = false;
    }

    // --- Search Logic ---
    function findResults(query) {
        if (!query || query.length < 2) return []; // Start searching after 2 characters
        
        const terms = query.toLowerCase().split(' ').filter(term => term.length > 0);
        
        return searchData.map(item => {
            let score = 0;
            const title = (item.title || '').toLowerCase();
            const content = (item.content || '').toLowerCase();
            const description = (item.description || '').toLowerCase();
            const tags = Array.isArray(item.tags) ? item.tags.join(' ').toLowerCase() : '';

            terms.forEach(term => {
                if (title.includes(term)) score += 10;
                if (description.includes(term)) score += 5;
                if (tags.includes(term)) score += 3;
                if (content.includes(term)) score += 1;
            });

            return { ...item, score };
        }).filter(item => item.score > 0).sort((a, b) => b.score - a.score);
    }
    
    // --- Rendering Logic ---
    function highlightText(text, query) {
        if (!text || !query) return text;
        const terms = query.toLowerCase().split(' ').filter(term => term.length > 0);
        let highlighted = text;
        terms.forEach(term => {
            const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            highlighted = highlighted.replace(regex, '<mark>$1</mark>');
        });
        return highlighted;
    }
    
    function renderResults(results, query) {
        // Remove the 'hidden' class to show the drawer
        searchResultsContainer.classList.remove('pagefind-ui__hidden');

        if (results.length === 0) {
            searchResultsContainer.innerHTML = `<div class="pagefind-ui__results-area svelte-1bkqzc5">
                                                    <p class="pagefind-ui__message svelte-1bkqzc5">No results for "${query}"</p>
                                                </div>`;
            return;
        }

        const resultsHtml = results.map(item => {
            const url = (item.url && item.url.startsWith('/')) ? siteBaseUrl + item.url : (item.url || '#');
            const title = item.title || 'Untitled';
            // Use description, or fallback to a snippet of content
            const excerpt = item.description || (item.content ? item.content.substring(0, 150) + '...' : '');

            return `<li class="pagefind-ui__result svelte-j9e30">
                        <div class="pagefind-ui__result-inner svelte-j9e30">
                            <p class="pagefind-ui__result-title svelte-j9e30">
                                <a class="pagefind-ui__result-link svelte-j9e30" href="${url}">${highlightText(title, query)}</a>
                            </p>
                            <p class="pagefind-ui__result-excerpt svelte-j9e30">${highlightText(excerpt, query)}</p>
                        </div>
                    </li>`;
        }).join('');
        
        searchResultsContainer.innerHTML = `<div class="pagefind-ui__results-area svelte-1bkqzc5">
                                                <p class="pagefind-ui__message svelte-1bkqzc5">${results.length} ${results.length === 1 ? 'result' : 'results'} for "${query}"</p>
                                                <ol class="pagefind-ui__results svelte-1bkqzc5">${resultsHtml}</ol>
                                            </div>`;
    }

    function clearResults() {
        searchInput.value = '';
        searchClearButton.classList.add('pagefind-ui__suppressed');
        searchResultsContainer.classList.add('pagefind-ui__hidden');
        searchResultsContainer.innerHTML = '';
    }

    // --- Event Handling ---
    function handleSearchInput(event) {
        const query = event.target.value.trim();
        
        if (query) {
            searchClearButton.classList.remove('pagefind-ui__suppressed');
        } else {
            clearResults();
            return;
        }

        // Debounce the search to avoid running on every keystroke
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => {
            const results = findResults(query);
            renderResults(results, query);
        }, 250); // 250ms delay
    }

    function setupEventListeners() {
        // Open modal
        openSearchButton.addEventListener('click', (e) => {
            e.preventDefault();
            openModal();
        });

        // Keyboard shortcut to open modal (Ctrl+K or Cmd+K)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                openModal();
            }
        });

        // Close modal
        modalBackdrop.addEventListener('click', (e) => {
            // Close only if the click is on the backdrop itself, not its children (the modal)
            if (e.target === modalBackdrop) {
                closeModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isModalOpen) {
                closeModal();
            }
        });

        // Handle search input
        searchInput.addEventListener('input', handleSearchInput);

        // Handle clear button
        searchClearButton.addEventListener('click', (e) => {
            e.preventDefault();
            clearResults();
            searchInput.focus();
        });
    }

    // --- Initialization ---
    function init() {
        fetch(searchDataUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!Array.isArray(data)) {
                    throw new Error("Search data is not a valid array.");
                }
                searchData = data;
                setupEventListeners();
                console.log("Search initialized successfully.");
            })
            .catch(error => {
                console.error("Could not initialize search:", error);
                // Optionally disable the search button if data fails to load
                openSearchButton.style.display = 'none';
            });
    }

    init();
});
</script>

<noscript>
  <div class="container mt-4">
    <div class="notification is-warning">
      <span class="icon"><i class="ph-bold ph-warning"></i></span>
      Please enable JavaScript to use the search functionality.
    </div>
  </div>
</noscript>