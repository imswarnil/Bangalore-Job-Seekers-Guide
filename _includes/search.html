<!--
  This file can be used as a standalone `search.html` page layout
  or as an `_includes/search.html` file.
-->

<style>
    /* 
      ================================================================
      CUSTOM SCSS FOR THE SEARCH COMPONENT
      Designed to blend with the Spruce CSS framework aesthetic.
      ================================================================
    */

    .search-layout {
        /* Optional: Add extra padding if this is a full page */
    }

    .search-form-wrapper {
        margin-bottom: 3rem;
        max-width: 768px; /* Constrain the search bar width */
        margin-inline: auto;
    }

    /* Use Spruce's stacked group for the form layout */
    .form-group--stacked .form-group-label {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding-inline: 1.25rem;
        background-color: var(--spruce-base-color-code-background);
        border-color: var(--spruce-form-color-border);
    }
    
    .form-group--stacked .form-control {
      /* Ensure the input takes up the available space */
      flex-grow: 1;
    }

    .search-button-loading {
        /* Simple loading text, matches button style */
        font-weight: var(--spruce-font-weight, 700);
    }


    .search-results-wrapper {
        margin-top: 3rem;
    }

    .search-results-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        border-bottom: 1px solid var(--spruce-base-color-border);
        padding-bottom: 1rem;
        margin-bottom: 2.5rem;
    }

    .search-results-count {
        color: var(--spruce-base-color-text);
        font-size: var(--spruce-font-size-sm);
    }

    .search-results-grid {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    /* Custom result card to replace Bulma's card */
    .result-card {
        background-color: var(--spruce-card-color-background);
        border: 1px solid var(--spruce-base-color-border);
        border-radius: var(--spruce-border-radius);
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
        position: relative; /* For the clickable overlay */
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--spruce-box-shadow);
    }

    .result-card__image {
        figure {
            margin: 0;
            background-color: var(--spruce-base-color-code-background);
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    }

    .result-card__content {
        padding: 1.5rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .result-card__title {
        font-family: var(--spruce-font-family-heading);
        font-weight: var(--spruce-font-weight-heading);
        font-size: 1.125rem;
        color: var(--spruce-base-color-heading);
        margin-bottom: 0.5rem;
        line-height: 1.3;
    }
    
    .result-card__title a {
        text-decoration: none;
        color: inherit;
    }
    
    .result-card__link-overlay {
        position: absolute;
        inset: 0;
        z-index: 1; /* Sits on top of content but below any interactive elements if needed */
    }

    .result-card__category {
        font-size: var(--spruce-font-size-sm);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
        color: var(--spruce-base-color-primary);
        margin-bottom: 0.75rem;
    }

    .result-card__excerpt {
        font-size: 0.95rem; /* Slightly smaller for balance */
        color: var(--spruce-base-color-text);
        line-height: 1.6;
    }

    .result-card__tags {
        margin-top: auto; /* Pushes tags to the bottom */
        padding-top: 1rem;
    }

    .result-card__tags .tag {
        display: inline-block;
        font-size: var(--spruce-font-size-sm);
        background-color: var(--spruce-base-color-code-background);
        color: var(--spruce-base-color-code-foreground);
        padding: 0.25em 0.75em;
        border-radius: 9999px;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }

    /* Message for "No Results" */
    .no-results-message {
        text-align: center;
        background-color: var(--spruce-footer-color-background);
        border: 1px dashed var(--spruce-base-color-border);
        border-radius: var(--spruce-border-radius);
        padding: 3rem;
    }

    .no-results-message .icon-placeholder {
        color: var(--spruce-form-color-border);
        margin-bottom: 1rem;
    }
    
    .no-results-message h3,
    .no-results-message p {
      color: var(--spruce-base-color-text);
    }

    /* CSS Spinner */
    .spinner-container {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--spruce-base-color-text);
    }
    .spinner {
        border: 4px solid var(--spruce-base-color-border);
        border-top: 4px solid var(--spruce-base-color-primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<section class="section search-layout">
    <div class="container container--narrow">

        <!-- Search Form -->
        <div class="search-form-wrapper">
            <form id="search-form" onsubmit="event.preventDefault(); performFullSearch(); return false;" role="search">
                <div class="form-group--stacked">
                    <div class="form-group-label" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                        </svg>
                    </div>
                    <input class="form-control form-control--lg" type="text" placeholder="Search posts, guides, stories..." name="q" id="search-input" autocomplete="off">
                    <button type="submit" id="search-submit-button" class="btn btn--primary btn--lg">
                        <span class="search-button-text">Search</span>
                        <span class="search-button-loading" style="display: none;">Searching...</span>
                    </button>
                </div>
            </form>
            <p id="search-helper-text" class="form-description" style="text-align: center; margin-top: 0.5rem;">
                Type for instant results or press Enter for a full search.
            </p>
        </div>

        <!-- Search Results Section -->
        <div id="search-results" class="search-results-wrapper" style="display: none;">
            <header class="search-results-header">
                <h2 class="h3">Search Results</h2>
                <p id="results-count" class="search-results-count"></p>
            </header>
            
            <div id="search-loading-spinner" style="display: none;">
                <div class="spinner-container">
                    <div class="spinner"></div>
                    <p>Searching...</p>
                </div>
            </div>

            <div class="search-results-grid" id="results-container">
                <!-- JS will inject result cards here -->
            </div>
            
            <div id="no-results" class="no-results-message" style="display: none;">
                <div class="icon-placeholder">
                    <svg xmlns="http://www.w3.org/2000/svg" width="3em" height="3em" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M16 11a1 1 0 0 1-1-1V4.5a1.5 1.5 0 0 0-3 0V5h-.5A1.5 1.5 0 0 0 10 6.5v3h-1.55a2.5 2.5 0 0 0-4.9 0H2v-1a1.5 1.5 0 0 0-3 0V11a1 1 0 0 1-1 1v2a1 1 0 0 1 1 1h14a1 1 0 0 1 1-1v-2zM2.5 12a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1zm2 0a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1zm2.5 0a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1zm3 0a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1zm2.5 0a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                    </svg>
                </div>
                <h3 class="h4">No results found</h3>
                <p>Try different keywords or check your spelling.</p>
            </div>
            
            <div id="search-error" style="display: none;">
                <!-- JS will inject an alert here -->
            </div>
        </div>
    </div>
</section>

<!-- =================================================================
     FULL JAVASCRIPT LOGIC FOR THE SEARCH PAGE
     ================================================================== -->
<script>
  // Global function for image fallbacks
  var fallbackImageHtml = function(categoryName, itemTitle) {
      // Your existing iconMap can be defined here or inside the main function
      const iconMap = {
          'blog': 'ph-bold ph-article', 'post': 'ph-bold ph-article', 'video': 'ph-bold ph-youtube-logo',
          'project': 'ph-bold ph-git-branch', 'course': 'ph-bold ph-graduation-cap', 'journal': 'ph-bold ph-notebook',
          'page': 'ph-bold ph-file', 'default': 'ph-bold ph-file-text'
      };
      const categoryKey = (categoryName || 'default').toLowerCase().replace(/\s+/g, '-');
      const iconClass = iconMap[categoryKey] || iconMap.default;
      const safeTitle = (itemTitle || '').replace(/'/g, "\\'").replace(/"/g, '"');
      return `<figure data-fallback-for="${safeTitle}">
                  <span class="icon" style="font-size: 3rem; color: var(--spruce-form-color-border);">
                      <i class="${iconClass}"></i>
                  </span>
              </figure>`;
  };

  document.addEventListener('DOMContentLoaded', function() {
    const siteBaseUrl = '{{ site.baseurl | default: "" }}';
    const endpoint = '{{ "/assets/search.json" | relative_url }}';
    const iconMap = {
        'blog': 'ph-bold ph-article', 'post': 'ph-bold ph-article', 'video': 'ph-bold ph-youtube-logo',
        'project': 'ph-bold ph-git-branch', 'course': 'ph-bold ph-graduation-cap', 'journal': 'ph-bold ph-notebook',
        'page': 'ph-bold ph-file', 'default': 'ph-bold ph-file-text'
    };
    
    let searchData = [];
    let isSearchLoading = false;

    // --- DOM Element References ---
    const searchInput = document.getElementById('search-input');
    const searchSubmitButton = document.getElementById('search-submit-button');
    const resultsContainer = document.getElementById('results-container');
    const searchResultsWrapper = document.getElementById('search-results');
    const noResultsDiv = document.getElementById('no-results');
    const resultsCountP = document.getElementById('results-count');
    const searchLoadingSpinnerDiv = document.getElementById('search-loading-spinner');
    const searchErrorDiv = document.getElementById('search-error');
    const searchForm = document.getElementById('search-form');
    
    // --- Helper Functions ---
    function getItemImage(item) {
        let imageUrl = null;
        if (item.image && typeof item.image === 'string' && item.image.trim() !== '') {
            imageUrl = item.image.trim();
            if (!imageUrl.startsWith('http') && !imageUrl.startsWith('/')) {
                imageUrl = '/' + imageUrl;
            }
            if (!imageUrl.startsWith('http')) {
                 imageUrl = siteBaseUrl + (imageUrl.startsWith('/') ? imageUrl : '/' + imageUrl);
            }
        }
        const categoryForFallback = item.category || 'default';
        const safeTitle = (item.title || '').replace(/'/g, "\\'").replace(/"/g, '"');
        if (imageUrl) {
            return `<figure>
                        <img src="${imageUrl}" alt="${safeTitle}" loading="lazy"
                             onerror="this.onerror=null; console.error('Image failed to load:', this.src); this.parentElement.outerHTML = fallbackImageHtml('${categoryForFallback}', '${safeTitle}');">
                    </figure>`;
        }
        return fallbackImageHtml(categoryForFallback, item.title);
    }

    function highlightText(text, terms) {
        if (!text || !terms || terms.length === 0) return text;
        let escapedText = String(text).replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">");
        let highlighted = escapedText;
        terms.sort((a, b) => b.length - a.length).forEach(term => {
            const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            try {
                const regex = new RegExp(`(${escapedTerm})`, 'gi');
                highlighted = highlighted.replace(regex, '<mark>$1</mark>');
            } catch (e) { console.warn(`Regex error for term "${term}": ${e}`); }
        });
        return highlighted;
    }

    function showLoading(show) {
        isSearchLoading = show;
        if (show) {
            resultsContainer.innerHTML = '';
            noResultsDiv.style.display = 'none';
            searchErrorDiv.style.display = 'none';
            searchLoadingSpinnerDiv.style.display = 'block';
            searchResultsWrapper.style.display = 'block';
        } else {
            searchLoadingSpinnerDiv.style.display = 'none';
        }
    }
    
    function showError(message) {
        showLoading(false);
        resultsContainer.innerHTML = '';
        resultsCountP.textContent = '';
        noResultsDiv.style.display = 'none';
        searchErrorDiv.innerHTML = `<div class="alert alert--danger">${message}</div>`;
        searchErrorDiv.style.display = 'block';
        searchResultsWrapper.style.display = 'block';
    }
    
    // --- Core Search Logic (Unchanged) ---
    function findResults(termToMatch, dataToSearch) {
        if (!termToMatch) return [];
        const terms = termToMatch.toLowerCase().split(' ').filter(term => term.length > 1);
        if (terms.length === 0) return [];

        return dataToSearch.map(item => {
            let score = 0;
            const itemTitle = (item.title || '').toLowerCase();
            const itemContent = (item.content || '').toLowerCase();
            const itemDesc = (item.description || '').toLowerCase();
            const itemTags = Array.isArray(item.tags) ? item.tags.join(' ').toLowerCase() : '';
            const itemCategory = (item.category || '').toLowerCase();
            
            terms.forEach(term => {
                if (itemTitle.includes(term)) score += 12;
                if (itemDesc.includes(term)) score += 4;
                if (itemTags.includes(term)) score += 6;
                if (itemCategory.includes(term)) score += 8;
                if (itemContent.includes(term)) score += 1;
            });
            return { ...item, score };
        }).filter(item => item.score > 0).sort((a, b) => b.score - a.score);
    }
    
    function generateStatsHtml(results) {
        if (!results || results.length === 0) return 'No results found.';
        const total = results.length;
        return `${total} ${total === 1 ? 'result' : 'results'} found.`;
    }

    // --- Display Logic (Updated for Spruce CSS) ---
    function displayResults(results, searchTerm) {
        searchErrorDiv.style.display = 'none';
        if (!searchTerm) {
            searchResultsWrapper.style.display = 'none';
            return;
        }
        
        const terms = searchTerm.toLowerCase().split(' ').filter(term => term.length > 1);
        resultsCountP.innerHTML = generateStatsHtml(results);

        if (results.length > 0) {
            resultsContainer.innerHTML = results.map(item => {
                const itemUrl = (item.url && item.url.startsWith('/')) ? siteBaseUrl + item.url : (item.url || '#');
                const displayTitle = item.title || 'Untitled';
                const categoryName = item.category || 'Page';
                const descMaxLength = 100;
                const descriptionSnippet = item.description ?
                    highlightText(String(item.description).substring(0, descMaxLength) + '...', terms) :
                    (item.content ? highlightText(String(item.content).substring(0, descMaxLength) + '...', terms) : '');

                const tagsHtml = Array.isArray(item.tags) ?
                    item.tags.slice(0, 3).map(tag => `<span class="tag">${highlightText(tag, terms)}</span>`).join('') : '';

                return `
                    <article class="result-card">
                        <a href="${itemUrl}" class="result-card__link-overlay" aria-label="${displayTitle}"></a>
                        <div class="result-card__image">
                            ${getItemImage(item)}
                        </div>
                        <div class="result-card__content">
                            <p class="result-card__category">${categoryName}</p>
                            <h3 class="result-card__title">
                                <a href="${itemUrl}">${highlightText(displayTitle, terms)}</a>
                            </h3>
                            <p class="result-card__excerpt">${descriptionSnippet}</p>
                            ${tagsHtml ? `<div class="result-card__tags">${tagsHtml}</div>` : ''}
                        </div>
                    </article>`;
            }).join('');
            noResultsDiv.style.display = 'none';
        } else {
            resultsContainer.innerHTML = '';
            const safeSearchTerm = searchTerm.replace(/</g, "<").replace(/>/g, ">");
            noResultsDiv.querySelector('h3').innerHTML = `No results for "${safeSearchTerm}"`;
            noResultsDiv.style.display = 'block';
        }
        searchResultsWrapper.style.display = 'block';
    }
    
    // --- Event Handling & Initialization ---
    let debounceTimer;
    function handleSearchInput() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            if (!isSearchLoading) {
                performFullSearch();
            }
        }, 400); // Debounce live search
    }

    function performFullSearch() {
        if (isSearchLoading) return;
        const term = searchInput.value.trim();
        if (!term) {
            searchResultsWrapper.style.display = 'none';
            return;
        }

        showLoading(true);
        // Use a small timeout to allow the loading spinner to render
        setTimeout(() => {
            try {
                const results = findResults(term, searchData);
                displayResults(results, term);
            } catch (e) {
                console.error("Error during search:", e);
                showError("An error occurred while searching.");
            } finally {
                showLoading(false);
            }
        }, 50);
    }
    
    function initSearch() {
        fetch(endpoint)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (!Array.isArray(data)) throw new Error("Search data is not a valid JSON array.");
                searchData = data;
                
                searchInput.addEventListener('input', handleSearchInput);
                searchForm.addEventListener('submit', performFullSearch);

                const urlParams = new URLSearchParams(window.location.search);
                const query = urlParams.get('q');
                if (query) {
                    searchInput.value = decodeURIComponent(query);
                    performFullSearch();
                }
            })
            .catch(e => {
                console.error('Search Initialization Error:', e);
                showError(`Failed to load search data. Please try again later.`);
            });
    }

    initSearch();
  });
</script>

<noscript>
  <div class="container" style="padding-top: 2rem;">
    <div class="alert alert--warning">
      Please enable JavaScript to use the search functionality.
    </div>
  </div>
</noscript>